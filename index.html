<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ãƒãƒªãƒ´ã‚§ãƒ¼ã‚¬ãƒ«ç†è«–ã«åŸºã¥ãæ„Ÿæƒ…è¨˜éŒ²ã‚¢ãƒ—ãƒª">
    <title>æ„Ÿæƒ…ã®è¨˜éŒ² - Ladder of Emotion</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ˜Š</text></svg>">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js timeã‚¹ã‚±ãƒ¼ãƒ«ç”¨ luxonã‚¢ãƒ€ãƒ—ã‚¿ -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <!-- html2canvas CDN -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>ğŸ˜Š æ„Ÿæƒ…ã®è¨˜éŒ²</h1>
            <p class="subtitle">ã‚ãªãŸã®ä»Šã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>
        </header>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="ladder">æ„Ÿæƒ…è¨˜éŒ²</button>
            <button class="tab-btn" data-tab="stats">çµ±è¨ˆ</button>
            <button class="tab-btn" data-tab="history">å±¥æ­´</button>
        </nav>

        <main class="main-content">
            <!-- æ„Ÿæƒ…è¨˜éŒ²ã‚¿ãƒ– -->
            <section class="ladder-section tab-content" data-tab-content="ladder">
                <div class="ladder-container">
                    <div class="ladder-button color-green" data-floor="9" data-description="è…¹è¶³è¿·èµ°ç¥çµŒç³» - æœ€ã‚‚å®‰å…¨ã§å®‰å¿ƒãªçŠ¶æ…‹">
                        <div class="button-content">
                            <span class="floor-number">9</span>
                            <span class="floor-title">è…¹è¶³è¿·èµ°ç¥çµŒç³»</span>
                            <span class="floor-desc">æœ€ã‚‚å®‰å…¨ã§å®‰å¿ƒãªçŠ¶æ…‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-green" data-floor="8" data-description="å®‰å…¨ - å®‰å¿ƒæ„ŸãŒã‚ã‚Šã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã„ã‚‹">
                        <div class="button-content">
                            <span class="floor-number">8</span>
                            <span class="floor-title">å®‰å…¨</span>
                            <span class="floor-desc">å®‰å¿ƒæ„ŸãŒã‚ã‚Šã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã„ã‚‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-green" data-floor="7" data-description="ç¤¾ä¼šçš„ - äººã¨ã®ç¹‹ãŒã‚Šã‚’æ„Ÿã˜ã¦ã„ã‚‹">
                        <div class="button-content">
                            <span class="floor-number">7</span>
                            <span class="floor-title">ç¤¾ä¼šçš„</span>
                            <span class="floor-desc">äººã¨ã®ç¹‹ãŒã‚Šã‚’æ„Ÿã˜ã¦ã„ã‚‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-blue" data-floor="6" data-description="äº¤æ„Ÿç¥çµŒç³» - æ´»ç™ºã§ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥">
                        <div class="button-content">
                            <span class="floor-number">6</span>
                            <span class="floor-title">äº¤æ„Ÿç¥çµŒç³»</span>
                            <span class="floor-desc">æ´»ç™ºã§ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥</span>
                        </div>
                    </div>
                    <div class="ladder-button color-blue" data-floor="5" data-description="å¯å‹•åŒ– - è¡Œå‹•çš„ã§å‹•ãå›ã‚ŠãŸã„">
                        <div class="button-content">
                            <span class="floor-number">5</span>
                            <span class="floor-title">å¯å‹•åŒ–</span>
                            <span class="floor-desc">è¡Œå‹•çš„ã§å‹•ãå›ã‚ŠãŸã„</span>
                        </div>
                    </div>
                    <div class="ladder-button color-blue" data-floor="4" data-description="é—˜äº‰/é€ƒèµ° - ç·Šå¼µã‚„ä¸å®‰ã‚’æ„Ÿã˜ã¦ã„ã‚‹">
                        <div class="button-content">
                            <span class="floor-number">4</span>
                            <span class="floor-title">é—˜äº‰/é€ƒèµ°</span>
                            <span class="floor-desc">ç·Šå¼µã‚„ä¸å®‰ã‚’æ„Ÿã˜ã¦ã„ã‚‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-gray" data-floor="3" data-description="èƒŒè¶³è¿·èµ°ç¥çµŒç³» - ç„¡æ°—åŠ›ã§ã‚„ã‚‹æ°—ãŒãªã„">
                        <div class="button-content">
                            <span class="floor-number">3</span>
                            <span class="floor-title">èƒŒè¶³è¿·èµ°ç¥çµŒç³»</span>
                            <span class="floor-desc">ç„¡æ°—åŠ›ã§ã‚„ã‚‹æ°—ãŒãªã„</span>
                        </div>
                    </div>
                    <div class="ladder-button color-gray" data-floor="2" data-description="ä¸å‹•åŒ– - å‹•ã‘ãšã«ã„ã‚‹çŠ¶æ…‹">
                        <div class="button-content">
                            <span class="floor-number">2</span>
                            <span class="floor-title">ä¸å‹•åŒ–</span>
                            <span class="floor-desc">å‹•ã‘ãšã«ã„ã‚‹çŠ¶æ…‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-gray" data-floor="1" data-description="ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ - å®Œå…¨ã«é–‰ã˜ã“ã‚‚ã£ãŸçŠ¶æ…‹">
                        <div class="button-content">
                            <span class="floor-number">1</span>
                            <span class="floor-title">ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³</span>
                            <span class="floor-desc">å®Œå…¨ã«é–‰ã˜ã“ã‚‚ã£ãŸçŠ¶æ…‹</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- çµ±è¨ˆã‚¿ãƒ– -->
            <section class="stats-section tab-content" data-tab-content="stats" style="display:none;">
                <h2>ğŸ“Š çµ±è¨ˆ</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-records">0</div>
                        <div class="stat-label">ç·è¨˜éŒ²æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="today-records">0</div>
                        <div class="stat-label">ä»Šæ—¥ã®è¨˜éŒ²</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-floor">-</div>
                        <div class="stat-label">å¹³å‡éšæ•°</div>
                    </div>
                </div>
            </section>

            <!-- å±¥æ­´ã‚¿ãƒ– -->
            <section class="history-section tab-content" data-tab-content="history" style="display:none;">
                <div class="history-header">
                    <h2>ğŸ“ è¨˜éŒ²å±¥æ­´</h2>
                    <div class="history-controls">
                        <button id="graph-export-btn" class="control-btn">ğŸ“Š ã‚°ãƒ©ãƒ•å‡ºåŠ›</button>
                        <button id="export-btn" class="control-btn">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button id="import-btn" class="control-btn">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <input type="file" id="import-file" accept=".csv" style="display:none;" />
                    </div>
                </div>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="æ—¥ä»˜ã‚„éšæ•°ã§æ¤œç´¢..." class="search-input">
                    <select id="floor-filter" class="filter-select" style="margin-left:8px;">
                        <option value="">å…¨ã¦ã®éšæ•°</option>
                        <option value="9">9éš</option>
                        <option value="8">8éš</option>
                        <option value="7">7éš</option>
                        <option value="6">6éš</option>
                        <option value="5">5éš</option>
                        <option value="4">4éš</option>
                        <option value="3">3éš</option>
                        <option value="2">2éš</option>
                        <option value="1">1éš</option>
                    </select>
                    <label style="margin-left:8px;font-size:0.95em;">
                        <input type="checkbox" id="memo-filter" style="vertical-align:middle;"> ãƒ¡ãƒ¢ã‚ã‚Šã®ã¿
                    </label>
                </div>
                <div id="history-list" class="history-list"></div>
            </section>
        </main>
    </div>

    <!-- ã‚°ãƒ©ãƒ•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="graph-modal" class="modal">
        <div class="modal-content graph-modal-content">
            <span class="close" id="graph-modal-close">&times;</span>
            <h3>ğŸ“Š ã‚°ãƒ©ãƒ•å‡ºåŠ›</h3>
            <div class="date-range-container">
                <div class="date-input-group">
                    <label for="start-date">é–‹å§‹æ—¥æ™‚:</label>
                    <input type="datetime-local" id="start-date" class="date-input">
                </div>
                <div class="date-input-group">
                    <label for="end-date">çµ‚äº†æ—¥æ™‚:</label>
                    <input type="datetime-local" id="end-date" class="date-input">
                </div>
            </div>
            <div class="graph-container" id="graph-container">
                <canvas id="emotion-chart" width="800" height="400"></canvas>
            </div>
            <div class="modal-actions">
                <button id="generate-graph-btn" class="btn-primary">ã‚°ãƒ©ãƒ•ç”Ÿæˆ</button>
                <button id="download-graph-btn" class="btn-secondary" style="display: none;">ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button id="graph-modal-cancel" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">è¨˜éŒ²å®Œäº†</h3>
            <p id="modal-message"></p>
            <div class="modal-actions">
                <button id="modal-ok" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ãƒ¢å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="memo-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="memo-modal-close">&times;</span>
            <h3 id="memo-modal-title">ãƒ¡ãƒ¢ã‚’å…¥åŠ›</h3>
            <p id="memo-modal-desc"></p>
            <textarea id="memo-input" rows="4" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰" style="width:100%;margin-top:1em;"></textarea>
            <div class="modal-actions">
                <button id="memo-cancel" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="memo-ok" class="btn-primary">è¨˜éŒ²ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(function() {
                    console.log('ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ');
                })
                .catch(function(error) {
                    console.log('ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                });
        }
    </script>

    <script>
        // --- DataManager ---
        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»å–å¾—ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’æ‹…å½“
        class DataManager {
            constructor() {
                this.records = [];
                this.loadData();
            }

            loadData() {
                const savedRecords = localStorage.getItem('emotion-records');
                if (savedRecords) {
                    this.records = JSON.parse(savedRecords).map(record => {
                        record.timestamp = new Date(record.timestamp);
                        return record;
                    });
                } else {
                    this.records = [];
                }
            }

            saveData() {
                localStorage.setItem('emotion-records', JSON.stringify(this.records));
            }

            addRecord(record) {
                this.records.unshift(record);
                this.saveData();
            }

            deleteRecord(target) {
                this.records = this.records.filter(r => r !== target);
                this.saveData();
            }

            clearAllRecords() {
                this.records = [];
                this.saveData();
            }

            exportData() {
                const header = ['æ—¥æ™‚', 'éšæ•°', 'èª¬æ˜', 'ãƒ¡ãƒ¢'];
                const rows = this.records.map(record => {
                    const date = new Date(record.timestamp);
                    const dateStr = date.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    const escape = v => '"' + (v ? String(v).replace(/"/g, '""') : '') + '"';
                    return [
                        escape(dateStr),
                        escape(record.floor),
                        escape(record.description),
                        escape(record.memo)
                    ].join(',');
                });
                const csv = [header.join(','), ...rows].join('\r\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `emotion-records-${new Date().toISOString().split('T')[0]}.csv`;
                if (navigator.userAgent.match(/iPad|iPhone|iPod/)) {
                    window.open(url, '_blank');
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                } else {
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
                }
                URL.revokeObjectURL(url);
            }

            importCSV(file, onComplete) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/).filter(line => line.trim());
                    if (lines.length < 2) {
                        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                        return;
                    }
                    const header = lines[0].split(',');
                    const idx = {
                        date: header.findIndex(h => h.includes('æ—¥æ™‚')),
                        floor: header.findIndex(h => h.includes('éšæ•°')),
                        desc: header.findIndex(h => h.includes('èª¬æ˜')),
                        memo: header.findIndex(h => h.includes('ãƒ¡ãƒ¢'))
                    };
                    if (idx.date < 0 || idx.floor < 0) {
                        alert('CSVãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸æ­£ã§ã™ã€‚');
                        return;
                    }
                    let imported = 0;
                    for (let i = 1; i < lines.length; i++) {
                        const cols = this.parseCSVLine(lines[i]);
                        if (!cols[idx.date] || !cols[idx.floor]) continue;
                        const record = {
                            timestamp: new Date(cols[idx.date]),
                            floor: parseInt(cols[idx.floor], 10),
                            description: cols[idx.desc] || '',
                            memo: cols[idx.memo] || ''
                        };
                        this.records.push(record);
                        imported++;
                    }
                    this.saveData();
                    if (onComplete) onComplete(imported);
                };
                reader.readAsText(file);
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes && line[i+1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current);
                return result;
            }
        }

        // --- UIManager ---
        // UIæç”»ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ãƒ»çµ±è¨ˆ/å±¥æ­´è¡¨ç¤ºãƒ»ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰UIã‚’æ‹…å½“
        class UIManager {
            constructor() {
                this.modalConfirmCallback = null;
            }

            updateStats(records) {
                const totalRecords = records.length;
                const today = new Date().toDateString();
                const todayRecords = records.filter(record => 
                    new Date(record.timestamp).toDateString() === today
                ).length;
                let avgFloor = '-';
                if (totalRecords > 0) {
                    const sum = records.reduce((acc, record) => acc + record.floor, 0);
                    avgFloor = (sum / totalRecords).toFixed(1);
                }
                const totalElem = document.getElementById('total-records');
                const todayElem = document.getElementById('today-records');
                const avgElem = document.getElementById('avg-floor');
                if (totalElem) totalElem.textContent = totalRecords;
                if (todayElem) todayElem.textContent = todayRecords;
                if (avgElem) avgElem.textContent = avgFloor;
            }

            updateHistoryView(records, onDelete) {
                const historyList = document.getElementById('history-list');
                if (!historyList) return;
                historyList.innerHTML = '';
                if (records.length === 0) {
                    historyList.innerHTML = '<div class="no-records">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                records.forEach((record, idx) => {
                    const recordElement = document.createElement('div');
                    recordElement.classList.add('history-item');
                    // å®‰å…¨ãªãƒ†ã‚­ã‚¹ãƒˆæŒ¿å…¥
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'history-info';
                    const floorDiv = document.createElement('div');
                    floorDiv.className = 'history-floor ' + this.getFloorClass(record.floor);
                    floorDiv.textContent = `${record.floor}éš`;
                    const descDiv = document.createElement('div');
                    descDiv.className = 'history-description';
                    descDiv.textContent = record.description || '';
                    infoDiv.appendChild(floorDiv);
                    infoDiv.appendChild(descDiv);
                    if (record.memo) {
                        const memoDiv = document.createElement('div');
                        memoDiv.className = 'history-memo';
                        memoDiv.textContent = `ğŸ“ ${record.memo}`;
                        infoDiv.appendChild(memoDiv);
                    }
                    recordElement.appendChild(infoDiv);
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'history-time';
                    timeDiv.textContent = new Intl.DateTimeFormat('ja-JP', {
                        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    }).format(new Date(record.timestamp));
                    recordElement.appendChild(timeDiv);
                    // å‰Šé™¤ãƒœã‚¿ãƒ³
                    const delBtn = document.createElement('button');
                    delBtn.className = 'history-delete-btn';
                    delBtn.textContent = 'ğŸ—‘';
                    delBtn.title = 'å‰Šé™¤';
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (onDelete) onDelete(record);
                    };
                    recordElement.appendChild(delBtn);
                    historyList.appendChild(recordElement);
                });
            }

            getFloorClass(floor) {
                if (floor >= 7) return 'floor-green';
                if (floor >= 4) return 'floor-blue';
                return 'floor-gray';
            }

            showModal(title, message, isConfirm = false, onConfirm = null) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                const okButton = document.getElementById('modal-ok');
                if (isConfirm) {
                    okButton.textContent = 'å‰Šé™¤ã™ã‚‹';
                    okButton.className = 'btn-danger';
                    this.modalConfirmCallback = () => {
                        if (onConfirm) onConfirm();
                        this.hideModal();
                    };
                    okButton.onclick = this.modalConfirmCallback;
                } else {
                    okButton.textContent = 'OK';
                    okButton.className = 'btn-primary';
                    okButton.onclick = () => this.hideModal();
                }
                document.getElementById('modal').style.display = 'block';
            }

            hideModal() {
                document.getElementById('modal').style.display = 'none';
            }

            setDefaultDates() {
                const today = new Date();
                const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const toDatetimeLocal = d => {
                    const pad = n => n.toString().padStart(2, '0');
                    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
                };
                const endElem = document.getElementById('end-date');
                const startElem = document.getElementById('start-date');
                if (endElem) endElem.value = toDatetimeLocal(today);
                if (startElem) startElem.value = toDatetimeLocal(oneWeekAgo);
            }

            showMemoModal(floor, description) {
                document.getElementById('memo-modal-title').textContent = `${floor}éšã®è¨˜éŒ²`;
                document.getElementById('memo-modal-desc').textContent = description;
                document.getElementById('memo-input').value = '';
                document.getElementById('memo-modal').style.display = 'block';
            }

            hideMemoModal() {
                document.getElementById('memo-modal').style.display = 'none';
            }
        }

        // --- ChartManager ---
        // ã‚°ãƒ©ãƒ•ç”Ÿæˆãƒ»æ›´æ–°ãƒ»ç”»åƒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’æ‹…å½“
        class ChartManager {
            constructor() {
                this.chart = null;
            }

            generateGraph(records, startDate, endDate) {
                // æ—¥ä»˜ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿
                const filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    return recordDate >= startDate && recordDate <= endDate;
                });
                if (filteredRecords.length === 0) {
                    return { error: 'æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã«è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚' };
                }
                filteredRecords.sort((a, b) => a.timestamp - b.timestamp);
                const data = filteredRecords.map(record => ({
                    x: new Date(record.timestamp),
                    y: record.floor
                }));
                const firstTime = new Date(filteredRecords[0].timestamp);
                const lastTime = new Date(filteredRecords[filteredRecords.length - 1].timestamp);
                // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
                if (this.chart) {
                    this.chart.destroy();
                }
                const ctx = document.getElementById('emotion-chart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'éšæ•°',
                            data: data,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            yAxisID: 'y',
                            spanGaps: true,
                            showLine: true,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `æ„Ÿæƒ…è¨˜éŒ²ã‚°ãƒ©ãƒ•ï¼ˆ${firstTime.toLocaleString('ja-JP')} - ${lastTime.toLocaleString('ja-JP')})`
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    tooltipFormat: 'MM/dd HH:mm',
                                    displayFormats: {
                                        minute: 'MM/dd HH:mm',
                                        hour: 'MM/dd HH:mm',
                                        day: 'MM/dd',
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'æ—¥æ™‚'
                                },
                                min: firstTime,
                                max: lastTime
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                min: 1,
                                max: 9,
                                title: {
                                    display: true,
                                    text: 'éšæ•°'
                                }
                            }
                        }
                    }
                });
                return { success: true };
            }

            downloadGraph() {
                const graphContainer = document.getElementById('graph-container');
                let firstTime = null, lastTime = null;
                if (this.chart && this.chart.data && this.chart.data.datasets[0] && this.chart.data.datasets[0].data.length > 0) {
                    const dataArr = this.chart.data.datasets[0].data;
                    firstTime = dataArr[0].x instanceof Date ? dataArr[0].x : new Date(dataArr[0].x);
                    lastTime = dataArr[dataArr.length-1].x instanceof Date ? dataArr[dataArr.length-1].x : new Date(dataArr[dataArr.length-1].x);
                }
                const format = d => {
                    const pad = n => n.toString().padStart(2, '0');
                    return d.getFullYear() + pad(d.getMonth()+1) + pad(d.getDate()) + '_' + pad(d.getHours()) + pad(d.getMinutes());
                };
                html2canvas(graphContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    width: 800,
                    height: 400
                }).then(canvas => {
                    const imgDataUrl = canvas.toDataURL('image/png');
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.display = 'block';
                    let filename = 'æ„Ÿæƒ…è¨˜éŒ²ã‚°ãƒ©ãƒ•';
                    if (firstTime && lastTime) {
                        filename += `[${format(firstTime)}]-[${format(lastTime)}]`;
                    }
                    filename += '.png';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:90vw;max-height:90vh;overflow:auto;text-align:center;">
                            <span class="close" id="img-modal-close" style="font-size:2rem;cursor:pointer;float:right;">&times;</span>
                            <h3>ã‚°ãƒ©ãƒ•ç”»åƒ</h3>
                            <p style="font-size:0.95em;">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã§ãã¾ã™ï¼ˆiPhone/Androidå¯¾å¿œï¼‰</p>
                            <a id="img-download-link" href="${imgDataUrl}" download="${filename}" style="display:inline-block;margin-bottom:1em;">â¬‡ï¸ ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
                            <img src="${imgDataUrl}" alt="ã‚°ãƒ©ãƒ•ç”»åƒ" style="max-width:100%;height:auto;border-radius:8px;box-shadow:0 2px 8px #0002;" />
                        </div>
                    `;
                    document.body.appendChild(modal);
                    document.getElementById('img-modal-close').onclick = () => {
                        document.body.removeChild(modal);
                    };
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    };
                });
            }
        }

        // --- App ---
        // å„ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–ãƒ»é€£æºã€å…¨ä½“ã®çŠ¶æ…‹ç®¡ç†
        class App {
            constructor() {
                this.dataManager = new DataManager();
                this.uiManager = new UIManager();
                this.chartManager = new ChartManager();
                this.filteredRecords = [...this.dataManager.records];
                this.selectedFloor = null;
                this.selectedDescription = '';
                this.setupEventListeners();
                this.updateAllUI();
            }

            setupEventListeners() {
                // ãƒ©ãƒ€ãƒ¼ãƒœã‚¿ãƒ³
                document.querySelectorAll('.ladder-button').forEach(button => {
                    button.addEventListener('click', (e) => this.handleLadderClick(e));
                    button.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.handleLadderClick(e);
                        }
                    });
                });
                // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿
                document.getElementById('search-input').addEventListener('input', () => this.filterRecords());
                document.getElementById('floor-filter').addEventListener('change', () => this.filterRecords());
                document.getElementById('memo-filter').addEventListener('change', () => this.filterRecords());
                // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                document.getElementById('export-btn').addEventListener('click', () => this.dataManager.exportData());
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                document.getElementById('import-btn').addEventListener('click', () => {
                    document.getElementById('import-file').click();
                });
                document.getElementById('import-file').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.dataManager.importCSV(file, (imported) => {
                            alert(`${imported}ä»¶ã®è¨˜éŒ²ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
                            this.filteredRecords = [...this.dataManager.records];
                            this.updateAllUI();
                        });
                    }
                    e.target.value = '';
                });
                // ã‚°ãƒ©ãƒ•ãƒ¢ãƒ¼ãƒ€ãƒ«
                document.getElementById('graph-export-btn').addEventListener('click', () => {
                    document.getElementById('graph-modal').style.display = 'block';
                    this.uiManager.setDefaultDates();
                });
                document.getElementById('graph-modal-close').addEventListener('click', () => {
                    document.getElementById('graph-modal').style.display = 'none';
                    if (this.chartManager.chart) {
                        this.chartManager.chart.destroy();
                        this.chartManager.chart = null;
                    }
                    document.getElementById('download-graph-btn').style.display = 'none';
                });
                document.getElementById('graph-modal-cancel').addEventListener('click', () => {
                    document.getElementById('graph-modal').style.display = 'none';
                    if (this.chartManager.chart) {
                        this.chartManager.chart.destroy();
                        this.chartManager.chart = null;
                    }
                    document.getElementById('download-graph-btn').style.display = 'none';
                });
                document.getElementById('generate-graph-btn').addEventListener('click', () => {
                    const startDateStr = document.getElementById('start-date').value;
                    const endDateStr = document.getElementById('end-date').value;
                    const startDate = startDateStr ? new Date(startDateStr) : new Date();
                    const endDate = endDateStr ? new Date(endDateStr) : new Date();
                    if (startDate > endDate) {
                        alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    const result = this.chartManager.generateGraph(this.dataManager.records, startDate, endDate);
                    if (result && result.error) {
                        alert(result.error);
                        return;
                    }
                    document.getElementById('download-graph-btn').style.display = 'inline-block';
                });
                document.getElementById('download-graph-btn').addEventListener('click', () => {
                    this.chartManager.downloadGraph();
                });
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒãƒ„ãƒœã‚¿ãƒ³
                document.querySelectorAll('.close').forEach(closeBtn => {
                    closeBtn.addEventListener('click', (e) => {
                        let modal = closeBtn.closest('.modal');
                        if (modal) modal.style.display = 'none';
                    });
                });
                // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«
                document.getElementById('memo-modal-close').addEventListener('click', () => this.uiManager.hideMemoModal());
                document.getElementById('memo-cancel').addEventListener('click', () => this.uiManager.hideMemoModal());
                document.getElementById('memo-ok').addEventListener('click', () => this.saveMemoRecord());
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯
                window.addEventListener('click', (e) => {
                    const modal = document.getElementById('modal');
                    const graphModal = document.getElementById('graph-modal');
                    const memoModal = document.getElementById('memo-modal');
                    if (e.target === modal) this.uiManager.hideModal();
                    if (e.target === graphModal) {
                        document.getElementById('graph-modal').style.display = 'none';
                        if (this.chartManager.chart) {
                            this.chartManager.chart.destroy();
                            this.chartManager.chart = null;
                        }
                        document.getElementById('download-graph-btn').style.display = 'none';
                    }
                    if (e.target === memoModal) this.uiManager.hideMemoModal();
                });
            }

            handleLadderClick(event) {
                const button = event.currentTarget;
                this.selectedFloor = parseInt(button.dataset.floor, 10);
                this.selectedDescription = button.dataset.description;
                this.uiManager.showMemoModal(this.selectedFloor, this.selectedDescription);
                button.classList.add('clicked');
                setTimeout(() => {
                    button.classList.remove('clicked');
                }, 200);
            }

            saveMemoRecord() {
                const memo = document.getElementById('memo-input').value;
                const floor = this.selectedFloor;
                const description = this.selectedDescription;
                const newRecord = {
                    floor: floor,
                    timestamp: new Date(),
                    description: description,
                    memo: memo
                };
                this.dataManager.addRecord(newRecord);
                this.filteredRecords.unshift(newRecord);
                this.updateAllUI();
                this.uiManager.hideMemoModal();
                this.uiManager.showModal(
                    'è¨˜éŒ²å®Œäº†',
                    `${floor}éšã€Œ${description.split(' - ')[0]}ã€ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚${memo ? '\nãƒ¡ãƒ¢: ' + memo : ''}`
                );
            }

            filterRecords() {
                const searchTerm = document.getElementById('search-input').value;
                const floorValue = document.getElementById('floor-filter').value;
                const memoOnly = document.getElementById('memo-filter').checked;
                this.filteredRecords = this.dataManager.records.filter(record => {
                    const dateStr = new Date(record.timestamp).toLocaleDateString('ja-JP');
                    const timeStr = new Date(record.timestamp).toLocaleTimeString('ja-JP');
                    const floorStr = record.floor.toString();
                    const descStr = record.description || '';
                    const memoStr = record.memo || '';
                    let match = true;
                    if (searchTerm.trim()) {
                        match = dateStr.includes(searchTerm) ||
                                timeStr.includes(searchTerm) ||
                                floorStr.includes(searchTerm) ||
                                descStr.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                memoStr.toLowerCase().includes(searchTerm.toLowerCase());
                    }
                    if (match && floorValue) {
                        match = record.floor.toString() === floorValue;
                    }
                    if (match && memoOnly) {
                        match = !!record.memo && record.memo.trim() !== '';
                    }
                    return match;
                });
                this.updateAllUI();
            }

            updateAllUI() {
                this.uiManager.updateStats(this.dataManager.records);
                this.uiManager.updateHistoryView(this.filteredRecords, (record) => this.confirmDeleteRecord(record));
            }

            confirmDeleteRecord(record) {
                this.uiManager.showModal(
                    'è¨˜éŒ²å‰Šé™¤',
                    'ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
                    true,
                    () => this.deleteRecord(record)
                );
            }

            deleteRecord(record) {
                this.dataManager.deleteRecord(record);
                this.filteredRecords = this.filteredRecords.filter(r => r !== record);
                this.updateAllUI();
                this.uiManager.showModal('å‰Šé™¤å®Œäº†', 'è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new App();
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const tab = btn.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        if(content.getAttribute('data-tab-content') === tab) {
                            content.style.display = '';
                        } else {
                            content.style.display = 'none';
                        }
                    });
                });
            });
        });
    </script>
</body>
</html>