<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ãƒãƒªãƒ´ã‚§ãƒ¼ã‚¬ãƒ«ç†è«–ã«åŸºã¥ãæ„Ÿæƒ…è¨˜éŒ²ã‚¢ãƒ—ãƒª">
    <title>æ„Ÿæƒ…ã®è¨˜éŒ² - Ladder of Emotion</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ˜Š</text></svg>">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas CDN -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>ğŸ˜Š æ„Ÿæƒ…ã®è¨˜éŒ²</h1>
            <p class="subtitle">ã‚ãªãŸã®ä»Šã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>
        </header>

        <main class="main-content">
            <section class="ladder-section">
                <div class="ladder-container">
                    <div class="ladder-button color-green" data-floor="9" data-description="è…¹è¶³è¿·èµ°ç¥çµŒç³» - æœ€ã‚‚å®‰å…¨ã§å®‰å¿ƒãªçŠ¶æ…‹">
                        <div class="button-content">
                            <span class="floor-number">9</span>
                            <span class="floor-title">è…¹è¶³è¿·èµ°ç¥çµŒç³»</span>
                            <span class="floor-desc">æœ€ã‚‚å®‰å…¨ã§å®‰å¿ƒãªçŠ¶æ…‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-green" data-floor="8" data-description="å®‰å…¨ - å®‰å¿ƒæ„ŸãŒã‚ã‚Šã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã„ã‚‹">
                        <div class="button-content">
                            <span class="floor-number">8</span>
                            <span class="floor-title">å®‰å…¨</span>
                            <span class="floor-desc">å®‰å¿ƒæ„ŸãŒã‚ã‚Šã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã„ã‚‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-green" data-floor="7" data-description="ç¤¾ä¼šçš„ - äººã¨ã®ç¹‹ãŒã‚Šã‚’æ„Ÿã˜ã¦ã„ã‚‹">
                        <div class="button-content">
                            <span class="floor-number">7</span>
                            <span class="floor-title">ç¤¾ä¼šçš„</span>
                            <span class="floor-desc">äººã¨ã®ç¹‹ãŒã‚Šã‚’æ„Ÿã˜ã¦ã„ã‚‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-blue" data-floor="6" data-description="äº¤æ„Ÿç¥çµŒç³» - æ´»ç™ºã§ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥">
                        <div class="button-content">
                            <span class="floor-number">6</span>
                            <span class="floor-title">äº¤æ„Ÿç¥çµŒç³»</span>
                            <span class="floor-desc">æ´»ç™ºã§ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥</span>
                        </div>
                    </div>
                    <div class="ladder-button color-blue" data-floor="5" data-description="å¯å‹•åŒ– - è¡Œå‹•çš„ã§å‹•ãå›ã‚ŠãŸã„">
                        <div class="button-content">
                            <span class="floor-number">5</span>
                            <span class="floor-title">å¯å‹•åŒ–</span>
                            <span class="floor-desc">è¡Œå‹•çš„ã§å‹•ãå›ã‚ŠãŸã„</span>
                        </div>
                    </div>
                    <div class="ladder-button color-blue" data-floor="4" data-description="é—˜äº‰/é€ƒèµ° - ç·Šå¼µã‚„ä¸å®‰ã‚’æ„Ÿã˜ã¦ã„ã‚‹">
                        <div class="button-content">
                            <span class="floor-number">4</span>
                            <span class="floor-title">é—˜äº‰/é€ƒèµ°</span>
                            <span class="floor-desc">ç·Šå¼µã‚„ä¸å®‰ã‚’æ„Ÿã˜ã¦ã„ã‚‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-gray" data-floor="3" data-description="èƒŒè¶³è¿·èµ°ç¥çµŒç³» - ç„¡æ°—åŠ›ã§ã‚„ã‚‹æ°—ãŒãªã„">
                        <div class="button-content">
                            <span class="floor-number">3</span>
                            <span class="floor-title">èƒŒè¶³è¿·èµ°ç¥çµŒç³»</span>
                            <span class="floor-desc">ç„¡æ°—åŠ›ã§ã‚„ã‚‹æ°—ãŒãªã„</span>
                        </div>
                    </div>
                    <div class="ladder-button color-gray" data-floor="2" data-description="ä¸å‹•åŒ– - å‹•ã‘ãšã«ã„ã‚‹çŠ¶æ…‹">
                        <div class="button-content">
                            <span class="floor-number">2</span>
                            <span class="floor-title">ä¸å‹•åŒ–</span>
                            <span class="floor-desc">å‹•ã‘ãšã«ã„ã‚‹çŠ¶æ…‹</span>
                        </div>
                    </div>
                    <div class="ladder-button color-gray" data-floor="1" data-description="ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ - å®Œå…¨ã«é–‰ã˜ã“ã‚‚ã£ãŸçŠ¶æ…‹">
                        <div class="button-content">
                            <span class="floor-number">1</span>
                            <span class="floor-title">ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³</span>
                            <span class="floor-desc">å®Œå…¨ã«é–‰ã˜ã“ã‚‚ã£ãŸçŠ¶æ…‹</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="stats-section">
                <h2>ğŸ“Š çµ±è¨ˆ</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-records">0</div>
                        <div class="stat-label">ç·è¨˜éŒ²æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="today-records">0</div>
                        <div class="stat-label">ä»Šæ—¥ã®è¨˜éŒ²</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-floor">-</div>
                        <div class="stat-label">å¹³å‡éšæ•°</div>
                    </div>
                </div>
            </section>

            <section class="history-section">
                <div class="history-header">
                    <h2>ğŸ“ è¨˜éŒ²å±¥æ­´</h2>
                    <div class="history-controls">
                        <button id="graph-export-btn" class="control-btn">ğŸ“Š ã‚°ãƒ©ãƒ•å‡ºåŠ›</button>
                        <button id="export-btn" class="control-btn">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button id="clear-btn" class="control-btn danger">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="æ—¥ä»˜ã‚„éšæ•°ã§æ¤œç´¢..." class="search-input">
                </div>
                <div id="history-list" class="history-list"></div>
            </section>
        </main>
    </div>

    <!-- ã‚°ãƒ©ãƒ•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="graph-modal" class="modal">
        <div class="modal-content graph-modal-content">
            <span class="close" id="graph-modal-close">&times;</span>
            <h3>ğŸ“Š ã‚°ãƒ©ãƒ•å‡ºåŠ›</h3>
            <div class="date-range-container">
                <div class="date-input-group">
                    <label for="start-date">é–‹å§‹æ—¥:</label>
                    <input type="date" id="start-date" class="date-input">
                </div>
                <div class="date-input-group">
                    <label for="end-date">çµ‚äº†æ—¥:</label>
                    <input type="date" id="end-date" class="date-input">
                </div>
            </div>
            <div class="graph-container" id="graph-container">
                <canvas id="emotion-chart" width="800" height="400"></canvas>
            </div>
            <div class="modal-actions">
                <button id="generate-graph-btn" class="btn-primary">ã‚°ãƒ©ãƒ•ç”Ÿæˆ</button>
                <button id="download-graph-btn" class="btn-secondary" style="display: none;">ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button id="graph-modal-cancel" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">è¨˜éŒ²å®Œäº†</h3>
            <p id="modal-message"></p>
            <div class="modal-actions">
                <button id="modal-ok" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(function() {
                    console.log('ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ');
                })
                .catch(function(error) {
                    console.log('ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                });
        }
    </script>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ç®¡ç†
        class EmotionApp {
            constructor() {
                this.records = [];
                this.filteredRecords = [];
                this.chart = null;
                this.init();
            }

            init() {
                this.loadData();
                this.setupEventListeners();
                this.updateUI();
                this.setDefaultDates();
            }

            loadData() {
                const savedRecords = localStorage.getItem('emotion-records');
                if (savedRecords) {
                    this.records = JSON.parse(savedRecords).map(record => {
                        record.timestamp = new Date(record.timestamp);
                        return record;
                    });
                }
                this.filteredRecords = [...this.records];
            }

            saveData() {
                localStorage.setItem('emotion-records', JSON.stringify(this.records));
            }

            setDefaultDates() {
                const today = new Date();
                const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                document.getElementById('end-date').value = today.toISOString().split('T')[0];
                document.getElementById('start-date').value = oneWeekAgo.toISOString().split('T')[0];
            }

            setupEventListeners() {
                // ãƒ©ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                document.querySelectorAll('.ladder-button').forEach(button => {
                    button.addEventListener('click', (e) => this.handleLadderClick(e));
                    button.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.handleLadderClick(e);
                        }
                    });
                });

                // æ¤œç´¢æ©Ÿèƒ½
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.filterRecords(e.target.value);
                });

                // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
                document.getElementById('export-btn').addEventListener('click', () => {
                    this.exportData();
                });

                // ã‚°ãƒ©ãƒ•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
                document.getElementById('graph-export-btn').addEventListener('click', () => {
                    this.showGraphModal();
                });

                // ã‚¯ãƒªã‚¢æ©Ÿèƒ½
                document.getElementById('clear-btn').addEventListener('click', () => {
                    this.showConfirmDialog();
                });

                // ã‚°ãƒ©ãƒ•ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
                document.getElementById('graph-modal-close').addEventListener('click', () => {
                    this.hideGraphModal();
                });

                document.getElementById('graph-modal-cancel').addEventListener('click', () => {
                    this.hideGraphModal();
                });

                document.getElementById('generate-graph-btn').addEventListener('click', () => {
                    this.generateGraph();
                });

                document.getElementById('download-graph-btn').addEventListener('click', () => {
                    this.downloadGraph();
                });

                // ãƒ¢ãƒ¼ãƒ€ãƒ«
                document.querySelector('.close').addEventListener('click', () => {
                    this.hideModal();
                });

                document.getElementById('modal-ok').addEventListener('click', () => {
                    this.hideModal();
                });

                // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                window.addEventListener('click', (e) => {
                    const modal = document.getElementById('modal');
                    const graphModal = document.getElementById('graph-modal');
                    if (e.target === modal) {
                        this.hideModal();
                    }
                    if (e.target === graphModal) {
                        this.hideGraphModal();
                    }
                });
            }

            handleLadderClick(event) {
                const button = event.currentTarget;
                const floor = parseInt(button.dataset.floor, 10);
                const description = button.dataset.description;

                const newRecord = {
                    floor: floor,
                    timestamp: new Date(),
                    description: description
                };

                this.records.unshift(newRecord); // æ–°ã—ã„è¨˜éŒ²ã‚’å…ˆé ­ã«è¿½åŠ 
                this.filteredRecords.unshift(newRecord);
                this.saveData();
                this.updateUI();

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                this.showModal(
                    'è¨˜éŒ²å®Œäº†',
                    `${floor}éšã€Œ${description.split(' - ')[0]}ã€ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`
                );

                // ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                button.classList.add('clicked');
                setTimeout(() => {
                    button.classList.remove('clicked');
                }, 200);
            }

            filterRecords(searchTerm) {
                if (!searchTerm.trim()) {
                    this.filteredRecords = [...this.records];
                } else {
                    this.filteredRecords = this.records.filter(record => {
                        const dateStr = record.timestamp.toLocaleDateString('ja-JP');
                        const timeStr = record.timestamp.toLocaleTimeString('ja-JP');
                        const floorStr = record.floor.toString();
                        const descStr = record.description || '';
                        
                        return dateStr.includes(searchTerm) || 
                               timeStr.includes(searchTerm) || 
                               floorStr.includes(searchTerm) ||
                               descStr.toLowerCase().includes(searchTerm.toLowerCase());
                    });
                }
                this.updateHistoryView();
            }

            updateUI() {
                this.updateStats();
                this.updateHistoryView();
            }

            updateStats() {
                const totalRecords = this.records.length;
                const today = new Date().toDateString();
                const todayRecords = this.records.filter(record => 
                    record.timestamp.toDateString() === today
                ).length;

                let avgFloor = '-';
                if (totalRecords > 0) {
                    const sum = this.records.reduce((acc, record) => acc + record.floor, 0);
                    avgFloor = (sum / totalRecords).toFixed(1);
                }

                document.getElementById('total-records').textContent = totalRecords;
                document.getElementById('today-records').textContent = todayRecords;
                document.getElementById('avg-floor').textContent = avgFloor;
            }

            updateHistoryView() {
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';

                if (this.filteredRecords.length === 0) {
                    historyList.innerHTML = '<div class="no-records">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                this.filteredRecords.forEach(record => {
                    const recordElement = document.createElement('div');
                    recordElement.classList.add('history-item');
                    
                    const formattedDate = new Intl.DateTimeFormat('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).format(record.timestamp);

                    const floorClass = this.getFloorClass(record.floor);

                    recordElement.innerHTML = `
                        <div class="history-info">
                            <div class="history-floor ${floorClass}">${record.floor}éš</div>
                            <div class="history-description">${record.description || ''}</div>
                        </div>
                        <div class="history-time">${formattedDate}</div>
                    `;

                    historyList.appendChild(recordElement);
                });
            }

            getFloorClass(floor) {
                if (floor >= 7) return 'floor-green';
                if (floor >= 4) return 'floor-blue';
                return 'floor-gray';
            }

            exportData() {
                const data = {
                    records: this.records,
                    exportDate: new Date().toISOString(),
                    totalRecords: this.records.length
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `emotion-records-${new Date().toISOString().split('T')[0]}.json`;
                
                // iOS Safariå¯¾å¿œ
                if (navigator.userAgent.match(/iPad|iPhone|iPod/)) {
                    // iOS Safariã§ã¯æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                    window.open(url, '_blank');
                    this.showModal('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†', 'ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                } else {
                    // ãã®ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é€šå¸¸é€šã‚Šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    this.showModal('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†', 'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
                }
                
                URL.revokeObjectURL(url);
            }

            showGraphModal() {
                document.getElementById('graph-modal').style.display = 'block';
                this.setDefaultDates();
            }

            hideGraphModal() {
                document.getElementById('graph-modal').style.display = 'none';
                if (this.chart) {
                    this.chart.destroy();
                    this.chart = null;
                }
                document.getElementById('download-graph-btn').style.display = 'none';
            }

            generateGraph() {
                const startDate = new Date(document.getElementById('start-date').value);
                const endDate = new Date(document.getElementById('end-date').value);
                
                if (startDate > endDate) {
                    this.showModal('ã‚¨ãƒ©ãƒ¼', 'é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // æ—¥ä»˜ç¯„å›²å†…ã®è¨˜éŒ²ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const filteredRecords = this.records.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    return recordDate >= startDate && recordDate <= endDate;
                });

                if (filteredRecords.length === 0) {
                    this.showModal('ã‚¨ãƒ©ãƒ¼', 'æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã«è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                // æ—¥ä»˜ã”ã¨ã«è¨˜éŒ²ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const recordsByDate = {};
                filteredRecords.forEach(record => {
                    const dateStr = record.timestamp.toISOString().split('T')[0];
                    if (!recordsByDate[dateStr]) {
                        recordsByDate[dateStr] = [];
                    }
                    recordsByDate[dateStr].push(record);
                });

                // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
                const sortedDates = Object.keys(recordsByDate).sort();

                // å„æ—¥ã®å¹³å‡éšæ•°ã‚’è¨ˆç®—
                const labels = [];
                const data = [];
                const counts = [];

                sortedDates.forEach(date => {
                    const dayRecords = recordsByDate[date];
                    const avgFloor = dayRecords.reduce((sum, record) => sum + record.floor, 0) / dayRecords.length;
                    
                    labels.push(new Date(date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                    data.push(avgFloor);
                    counts.push(dayRecords.length);
                });

                // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
                if (this.chart) {
                    this.chart.destroy();
                }

                // æ–°ã—ã„ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
                const ctx = document.getElementById('emotion-chart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å¹³å‡éšæ•°',
                            data: data,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            yAxisID: 'y'
                        }, {
                            label: 'è¨˜éŒ²å›æ•°',
                            data: counts,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1,
                            yAxisID: 'y1',
                            type: 'bar'
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `æ„Ÿæƒ…è¨˜éŒ²ã‚°ãƒ©ãƒ• (${startDate.toLocaleDateString('ja-JP')} - ${endDate.toLocaleDateString('ja-JP')})`
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                min: 1,
                                max: 9,
                                title: {
                                    display: true,
                                    text: 'éšæ•°'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                min: 0,
                                title: {
                                    display: true,
                                    text: 'è¨˜éŒ²å›æ•°'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        }
                    }
                });

                document.getElementById('download-graph-btn').style.display = 'inline-block';
            }

            downloadGraph() {
                const graphContainer = document.getElementById('graph-container');
                
                html2canvas(graphContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    width: 800,
                    height: 400
                }).then(canvas => {
                    const startDate = document.getElementById('start-date').value;
                    const endDate = document.getElementById('end-date').value;
                    const filename = `emotion-graph-${startDate}-to-${endDate}.png`;
                    
                    canvas.toBlob(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        
                        // iOS Safariå¯¾å¿œ
                        if (navigator.userAgent.match(/iPad|iPhone|iPod/)) {
                            // iOS Safariã§ã¯æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                            window.open(url, '_blank');
                            this.showModal('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†', 'ã‚°ãƒ©ãƒ•ç”»åƒã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸã€‚æ‰‹å‹•ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                        } else {
                            // ãã®ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é€šå¸¸é€šã‚Šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            this.showModal('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†', 'ã‚°ãƒ©ãƒ•ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
                        }
                        
                        URL.revokeObjectURL(url);
                    });
                });
            }

            showConfirmDialog() {
                this.showModal(
                    'ç¢ºèª',
                    'ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',
                    true
                );
            }

            clearAllRecords() {
                this.records = [];
                this.filteredRecords = [];
                this.saveData();
                this.updateUI();
                this.showModal('å‰Šé™¤å®Œäº†', 'ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }

            showModal(title, message, isConfirm = false) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                
                const okButton = document.getElementById('modal-ok');
                if (isConfirm) {
                    okButton.textContent = 'å‰Šé™¤ã™ã‚‹';
                    okButton.className = 'btn-danger';
                    okButton.onclick = () => {
                        this.clearAllRecords();
                        this.hideModal();
                    };
                } else {
                    okButton.textContent = 'OK';
                    okButton.className = 'btn-primary';
                    okButton.onclick = () => this.hideModal();
                }

                document.getElementById('modal').style.display = 'block';
            }

            hideModal() {
                document.getElementById('modal').style.display = 'none';
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new EmotionApp();
        });
    </script>
</body>
</html>